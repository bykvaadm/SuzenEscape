# TODO

## Идея

Для того чтобы написать какое-либо задание в первую очередь следует определить к какому типу вы его отнесете:
* флаг лежит в контейнере (напрмиер см уровни 1-4)
* флаг приносится внешним чекером (например см уровни 19-24)
* флаг достается по сети посредством взаимодействия с другим сервером (например см уровни 5,9)

## Структура

Структурно задания обычно выстраиваются в цепочки, так чтобы полученный флаг от предыдущего задания
можно было использовать как пароль для входа на следующее. Такой подход не обязателен в случае сложных заданий или
в качестве временного решения, пока цепочка не допишется

Задание представляет из себя папку, расположенную следующим образом:
```{root_project_dir}/chainX/levelY```
Таким образом любое задание входит в какую-нибудь цепочку (даже если оно там одно), а внутри каталога-цепочки должен быть
каталог с названием level + порядковый номер этого задания.

## Составляющие части задания

Необходимым и достаточным условием для сборки уровня является наличие Dockerfile в папке с уровнем.
Любые необходимые для сборки уровня файлы и каталоги должны также находиться в папке рядом с Dockerfile,
таким образом, чтобы сборка уровня была самодостаточна и не выходила за пределы директории с уровнем.

## Обязательные условия

Для того чтобы свести к минимуму повторения стратегических вещей, существует единый файл, содержащий
всю необходимую информацию по уровню: ansible/vars.yaml

При создании нового уровня следует по образцу поместить в массив levels[] новую цепочку
и создать элемент со следующими параметрами:
```yaml
- name    : suzenXX # имя задания, включая его номер (обязательное поле)
  password: "" # Флаг от предыдущего уровня или традиционно пароль = suzenXX, где XX - номер первого задания в цепочке (обязательное поле)
  sault   : "" # соль для пароля в /etc/passwd (6-8 любых символов) (обязательное поле)
  flag    : "" # флаг, который будет положен в задание при его генерировании (обязательное поле)
  config  : "" # при использовании bykva/busybinaries это набор исполняемых файлов, оставляемых после сборки задания.
  chain   : "" # номер цепочки в которую входит задание (обязательное поле)
```

Таким образом, ваш контейнер ОБЯЗАН принимать в качестве аргументов как минимум FLAG и использовать его при сборке уровня.
Наличие заданий, в которые флаг вшит жестко недопустимы, за редким исключением и оговариваются с автором проекта отдельно.

для генерирования флага я использую команду:
```pwgen 20 1 | base64```

## Этапы сборки нового задания

* Создать директорию chainX/levelY
* Создать запись с нужными параметрами в ansible/vars.yaml
* Написать Dockerfile и положить необходимые файлы
* Собрать задания, используя команду ./build.sh XX, где XX - номер уровня (можно использовать
  ./build.py XX)
* В случае если задание подразумевает внешнюю проверку, то сделать файл проверки:
  ansible/roles/deploy_tasks/templates/suzenXX.j2, где ХХ - номер уровня.
  Данный файл является bash-скриптом, которому передадут в качестве аргумента ID контейнера с нужным уровнем.
  Задача скрипта - выполнить exec внутрю контейнера, убедиться в выполненности задания, и если это так - положить флаг.

## Этапы раскатки нового задания на прод

После того как задание было успешно оттестировано локально, для раскатки на прод достаточно просто запустить ansible или
если вы используете vagrant просто ввести команду ```vagrant provision```

## Проверка

После раскатки образа в игровую платформу, подключитесь по ssh под логином, включающим номер вашего уровня,
затем выполните проверку работоспособности.


## Полезные команды

Для ускорения пересборки ВМ используйте такую команду (с перезагрузкой VM):
```text
vagrant reload -f --provision
```
или такую (без перезагрузки VM):
```text
vagrant rsync && vagrant provision
```
Эти команды выгружают локальные изменения в ВМ и выполняют настройку ansible.

## Как использовать переменные для ускорения интегрирования

На этом этапе считается что ваши задачи условно-готовы к интеграции в платформу и условно-работают.

1) Соберите платформу без веб интерфейса
```text
deploy_registry : true
deploy_web      : false
build_containers: true
install_docker  : true
vagrant         : true
registry_proto  : http
is_online       : "yes"
registry_host    : "127.0.0.1:5000"
tasks_to_build  : "1101 1102" # Здесь нужно через пробел указать уровни которые вы разрабатываете
```
2) После этого вы получите доступ к задачам:
```text
ssh suzen1101@127.0.0.1 -p 2222
```

2.1) Вы заметили ошибку в работе приложения. Исправьте ее и попробуйте пересобрать платформу снова.
В этот раз можно уже не выполнять роль с установкой registry и docker:
```text
deploy_registry : false
deploy_web      : false
build_containers: true
install_docker  : false
vagrant         : true
registry_proto  : http
is_online       : "yes"
registry_host    : "127.0.0.1:5000"
tasks_to_build  : "1101 1102"
```

Обратитесь к предыдущему подзаголовку для изучения того как перезапускать сборку своих задач при
интегрировании в платформу.

3) Последним пунктом следует выставить все переменные в положительные значения, для того чтобы полностью
собрать платформу и убедиться что она работает и ваши задачи доступны.
```text
deploy_registry : true
deploy_web      : true
build_containers: true
install_docker  : true
vagrant         : true
registry_proto  : http
is_online       : "yes"
registry_host    : "127.0.0.1:5000"
tasks_to_build  : "all"
```
